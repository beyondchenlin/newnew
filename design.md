# 视频合成设计规范

## 1. 系统架构
   - 采用模块化设计，每个功能独立封装
   - 使用 ffmpeg 作为底层视频处理引擎
   - 临时文件管理机制
   - 完整的错误处理和资源清理
   - 命令行参数配置系统
   - 多线程输出处理机制
   - Excel 文字内容管理

## 2. 素材准备
   ### 2.1 视频素材
   - 检查并获取 assets\pip1_videos 文件夹中的视频列表
   - 检查并获取 assets\pip2_videos 文件夹中的视频列表
   - 随机从 assets\pip1_videos 选择一个视频作为主视频
   - 支持的视频格式：.mp4
   - 确保所有输入视频可正常读取和处理
   - 防止相邻视频重复选择

   ### 2.2 文字素材
   - 从 Excel 文件中读取文字内容
   - Excel 文件格式要求：
     * 第一列：主标题文字
     * 第二列：副标题文字
   - 支持随机选择文字组合
   - 提供默认文字作为备选

## 3. 视频参数配置
   ### 3.1 尺寸配置
   - 主视频（左侧）：原始尺寸的 0.5 倍
   - 侧视频（右侧）：原始尺寸的 0.3 倍
   - 所有输出尺寸确保为 2 的倍数（编码要求）

   ### 3.2 位置配置
   - 主视频水平位置：x = 70（距离左边界约 1/10 屏幕宽度）
   - 侧视频水平位置：x = 470（距离左边界约 2/3 屏幕宽度）
   - 垂直位置：所有视频垂直居中

   ### 3.3 效果配置
   - 背景类型选择：
     * blur：高斯模糊背景（默认），sigma = 30（较强模糊效果）
     * black：纯黑色背景
   - 视频编码：libx264
   - 音频编码：aac
   - 编码优化：使用 stillimage 优化静态背景

## 4. 处理流程
   ### 4.1 背景视频处理
   #### 4.1.1 高斯模糊背景
   - 使用主视频作为背景源
   - 应用高斯模糊效果（sigma=30）
   - 移除音频
   - 获取时长作为最终视频总时长

   #### 4.1.2 纯黑背景
   - 使用 ffprobe 分别获取主视频的：
     * 宽度和高度（stream 信息）
     * 时长（format 信息）
   - 使用 color 源生成纯黑画面
   - 时长与主视频保持一致
   - 无音频轨道

   ### 4.2 主视频处理
   - 缩放至指定比例（0.5）
   - 保持原始音频
   - 放置在指定位置（x=70）
   - 保持视频原始帧率和质量

   ### 4.3 侧视频序列处理
   - 生成不重复的随机序列：
     * 记录上一个使用的视频
     * 优先选择未使用的视频
     * 必要时重复使用视频列表
   - 计算所需视频数量以匹配总时长
   - 所有视频缩放至指定比例（0.3）
   - 移除音频
   - 按序列顺序拼接

## 5. 视频合成
   ### 5.1 合成规则
   - 按层级叠加：背景层 -> 主视频层 -> 侧视频层 -> 文字层
   - 使用 filter_complex 进行复杂合成
   - 保持主视频音轨
   - 确保总时长一致
   - 使用 overlay 滤镜进行视频叠加

   ### 5.2 文字叠加
   - 主标题配置：
     * 字体：微软雅黑粗体
     * 大小：60px
     * 颜色：绿色
     * 位置：水平居中，垂直位置 h/2-100
     * 描边：3px 黑色
   - 副标题配置：
     * 字体：微软雅黑粗体
     * 大小：50px
     * 颜色：白色
     * 位置：水平居中，垂直位置 h/2+100
     * 描边：3px 黑色
   - 文字持续显示整个视频时长

   ### 5.3 输出参数
   - 编码预设：ultrafast（优化处理速度）
   - 视频配置：
     * profile: baseline
     * level: 3.0
     * maxrate: 2000k
     * bufsize: 4000k
     * pixel format: yuv420p
   - 音频配置：
     * codec: aac
     * bitrate: 192k

## 6. 文件管理
   ### 6.1 目录结构
   ```
   project/
   ├── assets/            # 资源目录
   │   ├── pip1_videos/  # 主视频素材
   │   ├── pip1_audio/   # 主视频音频素材
   │   ├── pip2_videos/  # 侧视频素材
   │   ├── pip3_videos/  # 备用视频素材
   │   └── main_videos/  # 主要视频素材
   ├── outputs/          # 输出目录（位于项目根目录，自动创建）
   │   └── output_{timestamp}.mp4  # 生成的视频文件，使用时间戳命名
   ├── video_synthesis/  # 核心代码目录
   │   ├── core/        # 核心功能模块
   │   ├── utils/       # 工具函数
   │   └── config/      # 配置文件
   └── main.py         # 主程序
   ```

   ### 6.2 临时文件管理
   - 自动创建临时目录
   - 处理完成后自动清理
   - 错误发生时确保清理
   - 临时文件命名规则：
     * background.mp4：背景视频
     * main.mp4：主视频
     * side_{i}.mp4：侧视频序列

## 7. 错误处理
   - 输入验证：
     * 确保所有输入视频存在且可访问
     * 验证视频文件夹存在
     * 检查视频格式是否为 .mp4
   - 运行时错误处理：
     * 捕获 ffmpeg 命令执行错误
     * 处理视频读取和解码错误
     * 监控进程执行状态
   - 资源管理：
     * 确保进程正确终止
     * 清理临时文件和目录
     * 释放文件句柄和进程资源

## 8. 性能优化
   - 使用 ultrafast 预设提高处理速度
   - 优化编码参数平衡质量和速度
   - 使用 fastdecode 优化解码性能
   - 合理设置缓冲区大小
   - 多线程处理输出流
   - 使用 warning 级别的日志减少输出

## 9. 命令行参数
   - --background: 选择背景类型（blur/black）
   - --excel: 指定文字内容的Excel文件路径
